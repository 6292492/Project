import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
from matplotlib import animation

sns.set_theme(style="whitegrid")

DATAFILE = "PK_sample.csv"


def load_params(path):
    """
    Load CSV containing drug PK parameters for each patient.
    Expected columns: PatientID, Dose, Vd, k
    """
    df = pd.read_csv(path)
    return df


def concentration_curve(dose, vd, k, t):
    """
    Compute concentration at time vector t using:
        C(t) = (Dose/Vd) * exp(-k*t)
    """
    return (dose / vd) * np.exp(-k * t)


def compute_metrics(df, t):
    """
    Compute Cmax, Tmax, and AUC using the simulated concentration data.
    """
    C_all = []
    Cmax_list = []
    Tmax_list = []
    AUC_list = []

    for i, row in df.iterrows():
        C = concentration_curve(row["Dose"], row["Vd"], row["k"], t)

        C_all.append(C)
        Cmax_list.append(np.max(C))
        Tmax_list.append(t[np.argmax(C)])
        AUC_list.append(np.trapezoid(C, t))

    df["C_curve"] = C_all
    df["Cmax"] = Cmax_list
    df["Tmax"] = Tmax_list
    df["AUC"] = AUC_list
    return df


def create_plots(df):
    """Generate PNG figures"""

    t = np.linspace(0, 20, 200)

    # 1 — Concentration curves
    plt.figure(figsize=(10, 5))
    for i, row in df.iterrows():
        plt.plot(t, row["C_curve"], label=row["PatientID"])
    plt.xlabel("Time")
    plt.ylabel("Concentration")
    plt.title("Concentration-time curves")
    plt.legend(title="PatientID")
    plt.savefig("concentration_curves.png")
    plt.close()

    # 2 — Histogram of Cmax
    plt.figure(figsize=(10, 5))
    sns.histplot(df["Cmax"], kde=True, bins=5, alpha=0.4)
    plt.xlabel("Cmax")
    plt.ylabel("Count")
    plt.title("Cmax Distribution")
    plt.savefig("cmax_hist.png")
    plt.close()

    # 3 — Dose vs Cmax scatter
    plt.figure(figsize=(8, 5))
    sns.scatterplot(data=df, x="Dose", y="Cmax", hue="PatientID", s=120)
    plt.title("Dose vs Cmax")
    plt.xlabel("Dose")
    plt.ylabel("Cmax")
    plt.savefig("dose_vs_cmax.png")
    plt.close()

    # 4 — AUC boxplot
    plt.figure(figsize=(8, 5))
    sns.boxplot(y=df["AUC"])
    plt.title("AUC Boxplot")
    plt.ylabel("AUC")
    plt.savefig("auc_boxplot.png")
    plt.close()


def make_animation(df, t):
    """Animate concentration vs time"""

    fig, ax = plt.subplots(figsize=(10, 5))
    lines = []
    for i, row in df.iterrows():
        (line,) = ax.plot([], [], label=f"Patient {row['PatientID']}")
        lines.append(line)

    ax.set_xlim(0, max(t))
    ax.set_ylim(0, max(df["Cmax"]) + 2)
    ax.set_xlabel("Time (h)")
    ax.set_ylabel("Concentration")
    ax.set_title("Time: 0.00 h")
    ax.legend()

    def update(frame):
        for i, row in df.iterrows():
            lines[i].set_data(t[:frame], row["C_curve"][:frame])
        ax.set_title(f"Time: {t[frame]:.2f} h")
        return lines

    ani = animation.FuncAnimation(fig, update, frames=len(t), interval=80)
    ani.save("pk_animation.gif", writer="pillow")
    plt.close()


def export_outputs(df):
    """Export PK summary tables"""

    df_summary = df[["PatientID", "Dose", "Vd", "k", "Cmax", "Tmax", "AUC"]]
    df_summary.to_csv("pk_summary.csv", index=False)

    df_auc = df[["PatientID", "AUC"]]
    df_auc.to_csv("patient_auc.csv", index=False)


if __name__ == "__main__":
    print("Loading data...")
    df = load_params(DATAFILE)

    # Time vector
    t = np.linspace(0, 20, 200)

    print("Computing PK metrics...")
    df = compute_metrics(df, t)

    print("Generating plots...")
    create_plots(df)

    print("Animating curves...")
    make_animation(df, t)

    print("Exporting outputs...")
    export_outputs(df)

    print("Project 7 completed successfully!")

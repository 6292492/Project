import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
from matplotlib import animation

# Setup seaborn theme for nicer formatting of figures
sns.set_theme(style="whitegrid")

# File path to dataset containing PK parameters for patients
DATAFILE = "PK_sample.csv"


def load_params(path):
    """
    Load CSV containing drug PK parameters for each patient.
    Expected columns: PatientID, Dose, Vd, k
    """
    df = pd.read_csv(path) # Load the dataset
    return df


def concentration_curve(dose, vd, k, t):
    """
    Compute concentration at time vector t using:
        C(t) = (Dose/Vd) * exp(-k*t)
    """
    return (dose / vd) * np.exp(-k * t) # Calculate concentration curve


def compute_metrics(df, t):
    """
    Compute Cmax, Tmax, and AUC using the simulated concentration data.
    """
    C_all = [] # list storing concentration curves for each patient
    Cmax_list = [] # list storing max concentration values
    Tmax_list = [] # list storing time of Cmax
    AUC_list = [] # list storing area under concentration-time curve

 # Loop over each row (patient) in DataFrame
    for i, row in df.iterrows():

        # Calculate concentration curve for this patient
        C = concentration_curve(row["Dose"], row["Vd"], row["k"], t)

        C_all.append(C)
        Cmax_list.append(np.max(C))  # highest concentration value
        Tmax_list.append(t[np.argmax(C)])  # time at which Cmax occurs
        AUC_list.append(np.trapezoid(C, t))  # numeric integration

    # Store new results in DataFrame
    df["C_curve"] = C_all
    df["Cmax"] = Cmax_list
    df["Tmax"] = Tmax_list
    df["AUC"] = AUC_list
    return df


def create_plots(df):
    """Generate PNG figures"""

    # Create a standard time vector for plotting
    t = np.linspace(0, 20, 200)

    # 1 — Concentration curves
    plt.figure(figsize=(10, 5))
    for i, row in df.iterrows():
        plt.plot(t, row["C_curve"], label=row["PatientID"]) # Plot each patient's curve
    plt.xlabel("Time") 
    plt.ylabel("Concentration")
    plt.title("Concentration-time curves")
    plt.legend(title="PatientID") # Add legend for patient IDs
    plt.savefig("concentration_curves.png") # Save figure
    plt.close()

    # 2 — Histogram of Cmax
    plt.figure(figsize=(10, 5))
    sns.histplot(df["Cmax"], kde=True, bins=5, alpha=0.4) # Histogram with kernel density estimate
    plt.xlabel("Cmax")
    plt.ylabel("Count")
    plt.title("Cmax Distribution")
    plt.savefig("cmax_hist.png")
    plt.close()

    # 3 — Dose vs Cmax scatter
    plt.figure(figsize=(8, 5))
    sns.scatterplot(data=df, x="Dose", y="Cmax", hue="PatientID", s=120) # Scatter plot of Dose vs Cmax
    plt.title("Dose vs Cmax")
    plt.xlabel("Dose")
    plt.ylabel("Cmax")
    plt.savefig("dose_vs_cmax.png")
    plt.close()

    # 4 — AUC boxplot
    plt.figure(figsize=(8, 5)) # Boxplot of AUC values
    sns.boxplot(y=df["AUC"]) # Create boxplot for AUC
    plt.title("AUC Boxplot")
    plt.ylabel("AUC")
    plt.savefig("auc_boxplot.png")
    plt.close()


def make_animation(df, t):
    """Animate concentration vs time"""

    fig, ax = plt.subplots(figsize=(10, 5))
    lines = [] # list storing animated line objects

    # Create empty plot line for each patient
    for i, row in df.iterrows():
        (line,) = ax.plot([], [], label=f"Patient {row['PatientID']}") # Initialize empty line
        lines.append(line)

    # Set plot limits based on data range
    ax.set_xlim(0, max(t)) # Set x limit to max time
    ax.set_ylim(0, max(df["Cmax"]) + 2) # Set y limit to accommodate max concentration
    ax.set_xlabel("Time (h)")
    ax.set_ylabel("Concentration")
    ax.set_title("Time: 0.00 h") 
    ax.legend()

    # Update animation frame by frame
    def update(frame):
        for i, row in df.iterrows(): # Update each patient's line
            lines[i].set_data(t[:frame], row["C_curve"][:frame]) # Set data for current frame
        ax.set_title(f"Time: {t[frame]:.2f} h") # Update title with current time
        return lines

    # Run animation and save as GIF
    ani = animation.FuncAnimation(fig, update, frames=len(t), interval=80) # Create animation
    ani.save("pk_animation.gif", writer="pillow") 
    plt.close()


def export_outputs(df):
    """Export PK summary tables"""

    # Save full PK summary table
    df_summary = df[["PatientID", "Dose", "Vd", "k", "Cmax", "Tmax", "AUC"]] # Select relevant columns
    df_summary.to_csv("pk_summary.csv", index=False) # Save summary table to CSV

    # Save AUC only table (one metric of interest)
    df_auc = df[["PatientID", "AUC"]] # Select only PatientID and AUC columns
    df_auc.to_csv("patient_auc.csv", index=False) # Save AUC table to CSV


if __name__ == "__main__":
    print("Loading data...") # Load the dataset containing PK parameters
    df = load_params(DATAFILE)

    # Time vector
    t = np.linspace(0, 20, 200)

    print("Computing PK metrics...") # Compute PK metrics for each patient
    df = compute_metrics(df, t)

    print("Generating plots...") # Create visualizations of PK data
    create_plots(df)

    print("Animating curves...") # Create animated visualization of concentration curves
    make_animation(df, t)

    print("Exporting outputs...") # Export summary tables with PK metrics
    export_outputs(df)

    print("Project 7 completed successfully!") # Indicate successful completion
